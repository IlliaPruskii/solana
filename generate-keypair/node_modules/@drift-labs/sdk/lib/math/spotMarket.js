"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculateSpotMarketMarginRatio = exports.castNumberToSpotPrecision = void 0;
const anchor_1 = require("@coral-xyz/anchor");
const types_1 = require("../types");
const spotBalance_1 = require("./spotBalance");
const numericConstants_1 = require("../constants/numericConstants");
const utils_1 = require("./utils");
function castNumberToSpotPrecision(value, spotMarket) {
    if (typeof value === 'number') {
        return (0, utils_1.numberToSafeBN)(value, new anchor_1.BN(Math.pow(10, spotMarket.decimals)));
    }
    else {
        return value.mul(new anchor_1.BN(Math.pow(10, spotMarket.decimals)));
    }
}
exports.castNumberToSpotPrecision = castNumberToSpotPrecision;
function calculateSpotMarketMarginRatio(market, oraclePrice, marginCategory, size, balanceType, customMarginRatio = 0) {
    let marginRatio;
    if ((0, types_1.isVariant)(balanceType, 'deposit')) {
        const assetWeight = (0, spotBalance_1.calculateAssetWeight)(size, oraclePrice, market, marginCategory);
        marginRatio = numericConstants_1.MARGIN_PRECISION.sub(assetWeight).toNumber();
    }
    else {
        const liabilityWeight = (0, spotBalance_1.calculateLiabilityWeight)(size, market, marginCategory);
        marginRatio = liabilityWeight.sub(numericConstants_1.MARGIN_PRECISION).toNumber();
    }
    if (marginCategory === 'Initial') {
        // use lowest leverage between max allowed and optional user custom max
        return Math.max(marginRatio, customMarginRatio);
    }
    return marginRatio;
}
exports.calculateSpotMarketMarginRatio = calculateSpotMarketMarginRatio;
